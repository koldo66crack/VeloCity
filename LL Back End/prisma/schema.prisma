generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Mirror of auth.users metadata for easy joins
model Profile {
  id             String               @id @db.Uuid
  fullName       String?              @map("full_name")
  email          String               @unique
  createdAt      DateTime             @map("created_at") @default(now())

  /// relations
  savedListings   SavedListing[]
  viewedListings  ViewedListing[]
  preferences     UserPreferences?
  groupsOwned     Group[]              @relation("GroupOwner")
  groupMembership GroupMember[]
  groupSaves      GroupSavedListing[]  @relation("GroupSavedListing_saver")
  listingVotes    ListingVote[]

  @@map("profiles")
}

/// Per-user search preferences
model UserPreferences {
  id          String   @id @default(cuid())
  userId      String   @unique @db.Uuid
  user        Profile  @relation(fields: [userId], references: [id])
  minBudget   Int?
  maxBudget   Int?
  bedrooms    Int?
  maxDistance Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

/// Listings a user has personally saved
model SavedListing {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  user      Profile  @relation(fields: [userId], references: [id])
  listingId String
  createdAt DateTime @default(now())

  @@unique([userId, listingId])
}

/// Listings a user has viewed
model ViewedListing {
  id        String   @id @default(cuid())
  userId    String   @db.Uuid
  user      Profile  @relation(fields: [userId], references: [id])
  listingId String
  viewedAt  DateTime @default(now())

  @@unique([userId, listingId])
}

/// A shared group of users
model Group {
  id             String               @id @default(cuid())
  createdAt      DateTime             @default(now())
  groupCode      String               @unique @default(uuid())
  ownerId        String               @db.Uuid
  owner          Profile              @relation("GroupOwner", fields: [ownerId], references: [id])

  members        GroupMember[]
  savedListings  GroupSavedListing[]
  listingVotes   ListingVote[]
}

/// Membership of a user in a group
model GroupMember {
  id        String    @id @default(cuid())
  groupId   String
  group     Group     @relation(fields: [groupId], references: [id])
  userId    String    @db.Uuid
  user      Profile   @relation(fields: [userId], references: [id])
  joinedAt  DateTime  @default(now())

  @@unique([groupId, userId])
}

/// Listings saved to a group dashboard
model GroupSavedListing {
  id          String   @id @default(cuid())
  groupId     String
  group       Group    @relation(fields: [groupId], references: [id])
  listingId   String
  savedBy     String   @db.Uuid
  saver       Profile  @relation("GroupSavedListing_saver", fields: [savedBy], references: [id])
  createdAt   DateTime @default(now())

  @@unique([groupId, listingId])
  @@index([groupId])
  @@index([listingId])
}

/// Upvotes / downvotes by group members on group listings
model ListingVote {
  id        String   @id @default(cuid())
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  listingId String
  userId    String   @db.Uuid
  user      Profile  @relation(fields: [userId], references: [id])
  vote      Int      // +1 for upvote, -1 for downvote
  createdAt DateTime @default(now())

  @@unique([groupId, listingId, userId])
}
